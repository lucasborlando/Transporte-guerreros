<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TRANSPORTE GUERREROS DEL CAMINO</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;font-family:system-ui;background:#0b0b0e;color:#e5e7eb;padding:14px}
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
.card{background:#111827;padding:16px;border-radius:14px;margin-bottom:14px}
label{font-size:.85rem}
input,select,textarea{width:100%;padding:10px;margin-bottom:10px;border-radius:8px;border:none;color:#333}
button{padding:10px;border-radius:8px;border:none;font-weight:600;cursor:pointer}
.btn{background:#22c55e;color:black}
.btn-sec{background:#334155;color:white}
.btn-danger{background:#dc2626;color:white}
.hidden{display:none}
.cierre-item{border:1px solid #333;padding:10px;border-radius:8px;margin-bottom:10px}
</style>
</head>

<body>

<div class="header">
<h2>TRANSPORTE GUERREROS DEL CAMINO</h2>
<button id="btnLogout" class="btn-danger hidden">Cerrar sesión</button>
</div>

<!-- LOGIN -->
<div id="auth" class="card">
<label>Email</label>
<input id="email" type="email">
<label>Contraseña</label>
<input id="password" type="password">
<label>Rol</label>
<select id="rolSelect">
<option value="" disabled selected>Seleccione rol</option>
<option value="conductor">Conductor</option>
<option value="controlador">Controlador</option>
<option value="admin">Administrador</option>
</select>
<button id="btnLogin" class="btn">Ingresar</button>
<button id="btnRegister" class="btn-sec">Registrar</button>
</div>

<!-- PANEL -->
<div id="panel" class="hidden">

<div class="card">
Rol: <b id="rolUsuario"></b> | Estado: <b id="estadoUsuario"></b>
</div>

<!-- CONDUCTOR -->
<div id="vistaConductor" class="hidden">
<div class="card">
<h3>Mis Cierres Mensuales</h3>
<div id="cierresConductor"></div>
</div>
</div>

<!-- CONTROLADOR -->
<div id="vistaControlador" class="hidden">
<div class="card">
<h3>Cierres Mensuales (Controlador)</h3>
<div id="cierresControlador"></div>
</div>
</div>

<!-- ADMIN -->
<div id="vistaAdmin" class="hidden">
<div class="card">
<h3>Cierres Mensuales (Administrador)</h3>
<div id="cierresAdmin"></div>
</div>
</div>

</div>

<script>
const supabase = window.supabase.createClient(
'https://ivbfughiyiihntlnbpet.supabase.co',
'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml2YmZ1Z2hpeWlpaG50bG5icGV0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY0NzQzNjYsImV4cCI6MjA4MjA1MDM2Nn0.YqIFdPkDGvLYpM0csqTM4xbJrFdgD0LZ6yySiTb5DQI'
);

/* LOGIN */
btnLogin.onclick = async () => {
const { data, error } = await supabase.auth.signInWithPassword({
email: email.value,
password: password.value
});
if(error) return alert(error.message);
iniciarSesion(data.user.id);
};

/* REGISTRO */
btnRegister.onclick = async () => {
const { data, error } = await supabase.auth.signUp({
email: email.value,
password: password.value
});
if(error) return alert(error.message);

await supabase.from('profiles').upsert({
id: data.user.id,
rol: rolSelect.value,
estado: 'pendiente'
});
alert('Registro enviado');
};

/* SESIÓN */
async function iniciarSesion(userId){
const { data:perfil } = await supabase
.from('profiles')
.select('*')
.eq('id',userId)
.single();

if(perfil.estado!=='activo'){
alert('Cuenta pendiente');
return supabase.auth.signOut();
}

auth.classList.add('hidden');
panel.classList.remove('hidden');
btnLogout.classList.remove('hidden');
rolUsuario.textContent = perfil.rol;
estadoUsuario.textContent = perfil.estado;

if(perfil.rol==='conductor'){
vistaConductor.classList.remove('hidden');
cargarCierresConductor(userId);
}
if(perfil.rol==='controlador'){
vistaControlador.classList.remove('hidden');
cargarCierresControlador();
}
if(perfil.rol==='admin'){
vistaAdmin.classList.remove('hidden');
cargarCierresAdmin();
}
}

/* CÁLCULO */
function calcular(c){
const km = c.km_fin - c.km_inicio;
const rend = c.combustible_consumido>0 ? (km/c.combustible_consumido).toFixed(2) : 'N/A';
return { km, rend };
}

/* CONDUCTOR */
async function cargarCierresConductor(uid){
const { data } = await supabase
.from('cierres_mensuales')
.select(`*,vehiculos!cierres_mensuales_vehiculo_id_fkey(matricula)`)
.eq('conductor_id',uid)
.order('fecha_cierre',{ascending:false});

cierresConductor.innerHTML='';
data.forEach(c=>{
const {km,rend}=calcular(c);
cierresConductor.innerHTML+=`
<div class="cierre-item">
<b>Vehículo:</b> ${c.vehiculos.matricula}<br>
<b>Fecha:</b> ${c.fecha_cierre}<br>
<b>KM recorridos:</b> ${km} km<br>
<b>Combustible consumido:</b> ${c.combustible_consumido} L<br>
<b>Rendimiento:</b> ${rend} km/L
</div>`;
});
}

/* CONTROLADOR */
async function cargarCierresControlador(){
const { data } = await supabase
.from('cierres_mensuales')
.select(`*,profiles!cierres_mensuales_conductor_id_fkey(rol),vehiculos!cierres_mensuales_vehiculo_id_fkey(matricula)`)
.order('fecha_cierre',{ascending:false});

cierresControlador.innerHTML='';
data.forEach(c=>{
const {km,rend}=calcular(c);
cierresControlador.innerHTML+=`
<div class="cierre-item">
<b>Vehículo:</b> ${c.vehiculos.matricula}<br>
<b>KM recorridos:</b> ${km} km<br>
<b>Rendimiento:</b> ${rend} km/L
</div>`;
});
}

/* ADMIN */
async function cargarCierresAdmin(){
const { data } = await supabase
.from('cierres_mensuales')
.select(`*,profiles!cierres_mensuales_conductor_id_fkey(rol),vehiculos!cierres_mensuales_vehiculo_id_fkey(matricula)`)
.order('fecha_cierre',{ascending:false});

cierresAdmin.innerHTML='';
data.forEach(c=>{
const {km,rend}=calcular(c);
cierresAdmin.innerHTML+=`
<div class="cierre-item">
<b>Vehículo:</b> ${c.vehiculos.matricula}<br>
<b>KM recorridos:</b> ${km} km<br>
<b>Rendimiento:</b> ${rend} km/L
</div>`;
});
}

/* LOGOUT */
btnLogout.onclick = async()=>{
await supabase.auth.signOut();
location.reload();
};

supabase.auth.getSession().then(({data})=>{
if(data.session) iniciarSesion(data.session.user.id);
});
</script>

</body>
</html>
