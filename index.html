<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TRANSPORTE GUERREROS DEL CAMINO</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;font-family:system-ui;background:#0b0b0e;color:#e5e7eb;padding:14px}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
.card{background:#111827;padding:16px;border-radius:14px;margin-bottom:14px}
label{font-size:.85rem}
input,select,textarea{width:100%;padding:10px;margin-bottom:10px;border-radius:8px;border:none;color:#333}
button{padding:10px;border-radius:8px;border:none;font-weight:600;cursor:pointer}
.btn{background:#22c55e;color:black}
.btn-sec{background:#334155;color:white}
.btn-danger{background:#dc2626;color:white}
.hidden{display:none}
.cierre-mensual-item{border:1px solid #333;padding:10px;margin-bottom:10px;border-radius:8px}
</style>
</head>

<body>

<div class="header">
<h2>TRANSPORTE GUERREROS DEL CAMINO</h2>
<button id="btnLogout" class="btn-danger hidden">Cerrar sesión</button>
</div>

<!-- LOGIN -->
<div id="auth" class="card">
<h3>Ingreso / Registro</h3>
<input id="email" type="email" placeholder="Email">
<input id="password" type="password" placeholder="Contraseña">
<select id="rolSelect">
<option disabled selected>Seleccione rol</option>
<option value="conductor">Conductor</option>
<option value="controlador">Controlador</option>
<option value="admin">Administrador</option>
</select>
<button id="btnLogin" class="btn">Ingresar</button>
<button id="btnRegister" class="btn-sec">Registrar</button>
</div>

<!-- PANEL -->
<div id="panel" class="hidden">

<div class="card">
Rol: <b id="rolUsuario"></b> | Estado: <b id="estadoUsuario"></b>
</div>

<!-- CONDUCTOR -->
<div id="vistaConductor" class="hidden card">
<h3>Panel Conductor</h3>

<h4>Cierre de Mes</h4>
<select id="capacidadEstanqueCierre">
<option value="1/4">1/4</option>
<option value="2/4">2/4</option>
<option value="3/4">3/4</option>
<option value="4/4">4/4</option>
</select>

<button id="btnCerrarMes" class="btn">Cerrar Mes</button>
<p id="mensajeCierre"></p>

<h4>Mis Cierres Mensuales</h4>
<div id="cierresMensualesConductor"></div>
</div>

<!-- CONTROLADOR -->
<div id="vistaControlador" class="hidden card">
<h3>Panel Controlador</h3>
<div id="cierresMensualesControlador"></div>
</div>

<!-- ADMIN -->
<div id="vistaAdmin" class="hidden card">
<h3>Panel Administrador</h3>
<div id="cierresMensualesAdmin"></div>
</div>

</div>

<script>
// ================= SUPABASE =================
const supabase = window.supabase.createClient(
'https://ivbfughiyiihntlnbpet.supabase.co',
'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml2YmZ1Z2hpeWlpaG50bG5icGV0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY0NzQzNjYsImV4cCI6MjA4MjA1MDM2Nn0.YqIFdPkDGvLYpM0csqTM4xbJrFdgD0LZ6yySiTb5DQI'
);

// ================= ELEMENTOS =================
const btnLogin = document.getElementById('btnLogin');
const btnRegister = document.getElementById('btnRegister');
const btnLogout = document.getElementById('btnLogout');

const email = document.getElementById('email');
const password = document.getElementById('password');
const rolSelect = document.getElementById('rolSelect');

const auth = document.getElementById('auth');
const panel = document.getElementById('panel');

const rolUsuario = document.getElementById('rolUsuario');
const estadoUsuario = document.getElementById('estadoUsuario');

const vistaConductor = document.getElementById('vistaConductor');
const vistaControlador = document.getElementById('vistaControlador');
const vistaAdmin = document.getElementById('vistaAdmin');

const btnCerrarMes = document.getElementById('btnCerrarMes');
const capacidadEstanqueCierre = document.getElementById('capacidadEstanqueCierre');
const mensajeCierre = document.getElementById('mensajeCierre');

let userId = null;
let rol = null;

// ================= LOGIN =================
btnLogin.onclick = async () => {
const { data, error } = await supabase.auth.signInWithPassword({
email: email.value,
password: password.value
});
if (error) return alert(error.message);
init(data.user.id);
};

// ================= REGISTRO =================
btnRegister.onclick = async () => {
if (!email.value || !password.value || !rolSelect.value)
return alert('Completa todos los campos');

const { data, error } = await supabase.auth.signUp({
email: email.value,
password: password.value
});
if (error) return alert(error.message);

await supabase.from('profiles').insert({
id: data.user.id,
rol: rolSelect.value,
estado: 'pendiente'
});

alert('Registro enviado. Espera aprobación.');
};

// ================= LOGOUT =================
btnLogout.onclick = async () => {
await supabase.auth.signOut();
location.reload();
};

// ================= SESIÓN =================
supabase.auth.getSession().then(({ data }) => {
if (data.session) init(data.session.user.id);
});

async function init(uid) {
userId = uid;

const { data: perfil, error } = await supabase
.from('profiles')
.select('*')
.eq('id', uid)
.single();

if (error || !perfil) return alert('Error perfil');

if (perfil.estado !== 'activo') {
await supabase.auth.signOut();
return alert('Cuenta pendiente');
}

auth.classList.add('hidden');
panel.classList.remove('hidden');
btnLogout.classList.remove('hidden');

rol = perfil.rol;
rolUsuario.textContent = rol;
estadoUsuario.textContent = perfil.estado;

vistaConductor.classList.add('hidden');
vistaControlador.classList.add('hidden');
vistaAdmin.classList.add('hidden');

if (rol === 'conductor') {
vistaConductor.classList.remove('hidden');
cargarCierresConductor();
}
if (rol === 'controlador') {
vistaControlador.classList.remove('hidden');
cargarCierresTodos('cierresMensualesControlador');
}
if (rol === 'admin') {
vistaAdmin.classList.remove('hidden');
cargarCierresTodos('cierresMensualesAdmin');
}
}

// ================= CIERRE MES =================
btnCerrarMes.onclick = async () => {

const { data: movs } = await supabase
.from('movimientos_diarios')
.select('km_salida, km_llegada, combustible_recibido')
.eq('conductor_id', userId);

if (!movs.length) return alert('No hay movimientos');

const kmInicio = movs[0].km_salida;
const kmFin = movs[movs.length - 1].km_llegada;
const kmRecorridos = kmFin - kmInicio;

const combustibleRecibido = movs.reduce((s,m)=>s + Number(m.combustible_recibido||0),0);

const { data: ultimo } = await supabase
.from('cierres_mensuales')
.select('combustible_final')
.eq('conductor_id', userId)
.order('fecha_cierre',{ascending:false})
.limit(1)
.maybeSingle();

const combustibleInicial = ultimo?.combustible_final || 0;

const [n,d] = capacidadEstanqueCierre.value.split('/').map(Number);
const capacidadEstanque = 100;
const combustibleFinal = (n/d)*capacidadEstanque;

const combustibleConsumido = combustibleInicial + combustibleRecibido - combustibleFinal;

if (combustibleConsumido <= 0 || combustibleConsumido > (combustibleInicial + combustibleRecibido))
return alert('❌ Error: combustible inconsistente');

const rendimiento = kmRecorridos / combustibleConsumido;

await supabase.from('cierres_mensuales').insert({
conductor_id: userId,
fecha_cierre: new Date().toISOString().slice(0,10),
combustible_inicial: combustibleInicial,
combustible_recibido: combustibleRecibido,
combustible_consumido: combustibleConsumido,
combustible_final: combustibleFinal,
km_inicio: kmInicio,
km_fin: kmFin,
km_recorridos: kmRecorridos,
rendimiento: rendimiento
});

mensajeCierre.textContent = `✔ Rendimiento: ${rendimiento.toFixed(2)} km/L`;
cargarCierresConductor();
};

// ================= MOSTRAR CIERRES =================
async function cargarCierresConductor(){
const { data } = await supabase
.from('cierres_mensuales')
.select('*')
.eq('conductor_id', userId);

cierresMensualesConductor.innerHTML = data.map(c=>`
<div class="cierre-mensual-item">
<b>Fecha:</b> ${c.fecha_cierre}<br>
<b>KM Recorridos:</b> ${c.km_recorridos}<br>
<b>Rendimiento:</b>
<span style="color:#22c55e">${c.rendimiento.toFixed(2)} km/L</span>
</div>`).join('');
}

async function cargarCierresTodos(div){
const { data } = await supabase.from('cierres_mensuales').select('*');
document.getElementById(div).innerHTML = data.map(c=>`
<div class="cierre-mensual-item">
<b>Conductor:</b> ${c.conductor_id}<br>
<b>KM:</b> ${c.km_recorridos}<br>
<b>Rendimiento:</b>
<span style="color:#22c55e">${c.rendimiento.toFixed(2)} km/L</span>
</div>`).join('');
}
</script>

</body>
</html>
