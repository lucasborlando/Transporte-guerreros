<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TRANSPORTE GUERREROS DEL CAMINO</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;font-family:system-ui;background:#0b0b0e;color:#e5e7eb;padding:14px}
.header{display:flex;justify-content:space-between;align-items:center}
.card{background:#111827;padding:16px;border-radius:14px;margin-bottom:14px}
input,select,textarea{width:100%;padding:8px;margin-bottom:8px;border-radius:6px}
button{padding:8px 12px;border-radius:6px;border:none;cursor:pointer;font-weight:600}
.btn{background:#22c55e}
.btn-sec{background:#334155;color:white}
.btn-danger{background:#dc2626;color:white}
.hidden{display:none}
.cierre{border:1px solid #333;padding:10px;border-radius:8px;margin-bottom:10px}
</style>
</head>

<body>

<div class="header">
  <h2>TRANSPORTE GUERREROS DEL CAMINO</h2>
  <button id="btnLogout" class="btn-danger hidden">Cerrar sesión</button>
</div>

<!-- LOGIN -->
<div id="auth" class="card">
  <h3>Ingreso / Registro</h3>
  <input id="email" type="email" placeholder="Email">
  <input id="password" type="password" placeholder="Contraseña">
  <select id="rolSelect">
    <option value="" disabled selected>Seleccione rol</option>
    <option value="conductor">Conductor</option>
    <option value="controlador">Controlador</option>
    <option value="admin">Administrador</option>
  </select>
  <button id="btnLogin" class="btn">Ingresar</button>
  <button id="btnRegister" class="btn-sec">Registrar</button>
</div>

<!-- PANEL -->
<div id="panel" class="hidden">

<div class="card">
Rol: <b id="rolUsuario"></b> | Estado: <b id="estadoUsuario"></b>
</div>

<!-- CONDUCTOR -->
<div id="vistaConductor" class="hidden card">
<h3>Panel Conductor</h3>

<input id="matriculaVehiculo" placeholder="Matrícula">
<input id="capacidadEstanque" type="number" placeholder="Capacidad estanque (L)">
<button id="btnAgregarVehiculo" class="btn">Agregar vehículo</button>

<hr>

<input id="fechaMovimiento" type="date">
<select id="vehiculoMovimiento"></select>
<input id="combustibleRecibido" type="number" placeholder="Combustible recibido">
<input id="kmSalida" type="number" placeholder="KM salida">
<input id="kmLlegada" type="number" placeholder="KM llegada">
<button id="btnAgregarMovimiento" class="btn">Agregar movimiento</button>

<hr>

<select id="capacidadEstanqueCierre">
<option value="1/4">1/4</option>
<option value="2/4">2/4</option>
<option value="3/4">3/4</option>
<option value="4/4">4/4</option>
</select>
<button id="btnCerrarMes" class="btn">Cerrar mes</button>

<h4>Mis cierres mensuales</h4>
<div id="cierresMensualesConductor"></div>
</div>

<!-- CONTROLADOR -->
<div id="vistaControlador" class="hidden card">
<h3>Panel Controlador</h3>
<div id="cierresMensualesControlador"></div>
</div>

<!-- ADMIN -->
<div id="vistaAdmin" class="hidden card">
<h3>Panel Administrador</h3>
<div id="cierresMensualesAdmin"></div>
</div>

</div>

<script>
document.addEventListener('DOMContentLoaded', () => {

const supabase = window.supabase.createClient(
  'https://ivbfughiyiihntlnbpet.supabase.co',
  'TU_ANON_KEY_AQUI'
);

const $ = id => document.getElementById(id);

let userId = null;

/* LOGIN */
$('btnLogin').onclick = async () => {
  const { data, error } = await supabase.auth.signInWithPassword({
    email: $('email').value,
    password: $('password').value
  });
  if (error) return alert(error.message);
  iniciarSesion(data.user.id);
};

/* REGISTRO */
$('btnRegister').onclick = async () => {
  const { data, error } = await supabase.auth.signUp({
    email: $('email').value,
    password: $('password').value
  });
  if (error) return alert(error.message);

  await supabase.from('profiles').insert({
    id: data.user.id,
    rol: $('rolSelect').value,
    estado: 'pendiente'
  });

  alert('Registro enviado');
};

/* LOGOUT */
$('btnLogout').onclick = async () => {
  await supabase.auth.signOut();
  location.reload();
};

async function iniciarSesion(uid){
  userId = uid;

  const { data: perfil } = await supabase
    .from('profiles')
    .select('*')
    .eq('id', uid)
    .single();

  $('auth').classList.add('hidden');
  $('panel').classList.remove('hidden');
  $('btnLogout').classList.remove('hidden');

  $('rolUsuario').textContent = perfil.rol;
  $('estadoUsuario').textContent = perfil.estado;

  if(perfil.rol === 'conductor'){
    $('vistaConductor').classList.remove('hidden');
    cargarCierresConductor();
  }

  if(perfil.rol === 'controlador'){
    $('vistaControlador').classList.remove('hidden');
    cargarCierresControlador();
  }

  if(perfil.rol === 'admin'){
    $('vistaAdmin').classList.remove('hidden');
    cargarCierresAdmin();
  }
}

/* CIERRES CONDUCTOR */
async function cargarCierresConductor(){
  const { data } = await supabase
    .from('cierres_mensuales')
    .select(`
      fecha_cierre,
      km_recorridos,
      rendimiento,
      vehiculos!cierres_mensuales_vehiculo_id_fkey (matricula)
    `)
    .eq('conductor_id', userId);

  $('cierresMensualesConductor').innerHTML = data.map(c => `
    <div class="cierre">
      Vehículo: ${c.vehiculos.matricula}<br>
      Fecha: ${c.fecha_cierre}<br>
      KM: ${c.km_recorridos}<br>
      Rendimiento: ${c.rendimiento.toFixed(2)} km/L
    </div>
  `).join('');
}

/* CIERRES CONTROLADOR */
async function cargarCierresControlador(){
  const { data } = await supabase
    .from('cierres_mensuales')
    .select(`
      fecha_cierre,
      km_recorridos,
      rendimiento,
      vehiculos!cierres_mensuales_vehiculo_id_fkey (matricula)
    `);

  $('cierresMensualesControlador').innerHTML = data.map(c => `
    <div class="cierre">
      Vehículo: ${c.vehiculos.matricula}<br>
      KM: ${c.km_recorridos}<br>
      Rendimiento: ${c.rendimiento.toFixed(2)}
    </div>
  `).join('');
}

/* CIERRES ADMIN */
async function cargarCierresAdmin(){
  const { data } = await supabase
    .from('cierres_mensuales')
    .select(`
      fecha_cierre,
      km_recorridos,
      rendimiento,
      vehiculos!cierres_mensuales_vehiculo_id_fkey (matricula)
    `);

  $('cierresMensualesAdmin').innerHTML = data.map(c => `
    <div class="cierre">
      Vehículo: ${c.vehiculos.matricula}<br>
      KM: ${c.km_recorridos}<br>
      Rendimiento: ${c.rendimiento.toFixed(2)}
    </div>
  `).join('');
}

});
</script>

</body>
</html>
