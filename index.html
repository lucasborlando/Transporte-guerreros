
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TRANSPORTE GUERREROS DEL CAMINO</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;font-family:system-ui;background:#0b0b0e;color:#e5e7eb;padding:14px}
.header{display:flex;justify-content:space-between;align-items:center}
.card{background:#111827;padding:16px;border-radius:14px;margin-bottom:14px}
label{font-size:.85rem}
input,select,textarea{width:100%;padding:10px;border-radius:8px;border:none;margin-bottom:10px}
button{padding:10px;border-radius:8px;border:none;font-weight:600;cursor:pointer}
.btn{background:#22c55e;color:black}
.btn-sec{background:#334155;color:white}
.btn-danger{background:#dc2626;color:white}
.hidden{display:none}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #333;padding:8px}
th{background:#334155}
.cierre-mensual-item{border:1px solid #333;padding:10px;margin-bottom:10px;border-radius:8px}
</style>
</head>

<body>

<div class="header">
<h2>TRANSPORTE GUERREROS DEL CAMINO</h2>
<button id="btnLogout" class="btn-danger hidden">Cerrar sesión</button>
</div>

<div id="auth" class="card">
<h3>Ingreso / Registro</h3>
<input id="email" placeholder="Email">
<input id="password" type="password" placeholder="Contraseña">
<select id="rolSelect">
<option disabled selected>Seleccione rol</option>
<option value="conductor">Conductor</option>
<option value="controlador">Controlador</option>
<option value="admin">Administrador</option>
</select>
<button id="btnLogin" class="btn">Ingresar</button>
<button id="btnRegister" class="btn-sec">Registrar</button>
</div>

<div id="panel" class="hidden">

<div class="card">
Rol: <b id="rolUsuario"></b> | Estado: <b id="estadoUsuario"></b>
</div>

<!-- CONDUCTOR -->
<div id="vistaConductor" class="hidden card">

<h3>Panel Conductor</h3>

<h4>Cierre de Mes</h4>
<select id="capacidadEstanqueCierre">
<option value="1/4">1/4</option>
<option value="2/4">2/4</option>
<option value="3/4">3/4</option>
<option value="4/4">4/4</option>
</select>
<button id="btnCerrarMes" class="btn">Cerrar Mes</button>
<p id="mensajeCierre"></p>

<h4>Mis Cierres Mensuales</h4>
<div id="cierresMensualesConductor"></div>

</div>

<!-- CONTROLADOR -->
<div id="vistaControlador" class="hidden card">
<h3>Panel Controlador</h3>
<div id="cierresMensualesControlador"></div>
</div>

<!-- ADMIN -->
<div id="vistaAdmin" class="hidden card">
<h3>Panel Administrador</h3>
<div id="cierresMensualesAdmin"></div>
</div>

</div>

<script>
const supabase = window.supabase.createClient(
'https://ivbfughiyiihntlnbpet.supabase.co',
'PUBLIC_ANON_KEY'
);

const $ = id => document.getElementById(id);

let userId = null;
let rol = null;
let vehiculos = [];

btnLogin.onclick = async ()=>{
const {data,error}=await supabase.auth.signInWithPassword({
email:email.value,password:password.value
});
if(error) return alert(error.message);
init(data.user.id);
};

btnRegister.onclick = async ()=>{
const {data,error}=await supabase.auth.signUp({
email:email.value,password:password.value
});
if(error) return alert(error.message);
await supabase.from('profiles').insert({
id:data.user.id,rol:rolSelect.value,estado:'pendiente'
});
alert('Registro enviado');
};

btnLogout.onclick = async ()=>{
await supabase.auth.signOut();
location.reload();
};

supabase.auth.getSession().then(({data})=>{
if(data.session) init(data.session.user.id);
});

async function init(uid){
userId=uid;
const {data:perfil}=await supabase.from('profiles').select('*').eq('id',uid).single();
if(perfil.estado!=='activo') return alert('Cuenta no activa');

$('auth').classList.add('hidden');
$('panel').classList.remove('hidden');
$('btnLogout').classList.remove('hidden');

rol=perfil.rol;
$('rolUsuario').textContent=rol;
$('estadoUsuario').textContent=perfil.estado;

if(rol==='conductor'){ $('vistaConductor').classList.remove('hidden'); cargarCierres(uid); }
if(rol==='controlador'){ $('vistaControlador').classList.remove('hidden'); cargarCierresTodos('cierresMensualesControlador'); }
if(rol==='admin'){ $('vistaAdmin').classList.remove('hidden'); cargarCierresTodos('cierresMensualesAdmin'); }
}

/* CIERRE DE MES */
btnCerrarMes.onclick = async ()=>{
const fraccion=$('capacidadEstanqueCierre').value;

const {data:movs}=await supabase
.from('movimientos_diarios')
.select('km_salida,km_llegada,combustible_recibido')
.eq('conductor_id',userId);

if(!movs.length) return alert('Sin movimientos');

const kmInicio=movs[0].km_salida;
const kmFin=movs[movs.length-1].km_llegada;
const kmRecorridos=kmFin-kmInicio;

const combRec=movs.reduce((s,m)=>s+Number(m.combustible_recibido||0),0);

const {data:ant}=await supabase.from('cierres_mensuales')
.select('combustible_final')
.eq('conductor_id',userId)
.order('fecha_cierre',{ascending:false})
.limit(1).maybeSingle();

const combIni=ant?.combustible_final||0;

const capacidad=vehiculos[0]?.capacidad_estanque||100;
const [n,d]=fraccion.split('/').map(Number);
const combFinal=(n/d)*capacidad;

const combConsumido=combIni+combRec-combFinal;

if(combConsumido<0||combConsumido>(combIni+combRec))
return alert('❌ Error de combustible');

const rendimiento=kmRecorridos/combConsumido;

await supabase.from('cierres_mensuales').insert({
conductor_id:userId,
fecha_cierre:new Date().toISOString().slice(0,10),
combustible_inicial:combIni,
combustible_recibido:combRec,
combustible_consumido:combConsumido,
combustible_final:combFinal,
km_inicio:kmInicio,
km_fin:kmFin,
km_recorridos:kmRecorridos,
rendimiento:rendimiento
});

$('mensajeCierre').textContent=`✔ Rendimiento: ${rendimiento.toFixed(2)} km/L`;
cargarCierres(userId);
};

async function cargarCierres(uid){
const {data}=await supabase.from('cierres_mensuales')
.select('*').eq('conductor_id',uid);

$('cierresMensualesConductor').innerHTML=data.map(c=>`
<div class="cierre-mensual-item">
<b>Fecha:</b> ${c.fecha_cierre}<br>
<b>KM:</b> ${c.km_recorridos}<br>
<b>Rendimiento:</b>
<span style="color:#22c55e">${c.rendimiento.toFixed(2)} km/L</span>
</div>
`).join('');
}

async function cargarCierresTodos(div){
const {data}=await supabase.from('cierres_mensuales').select('*');
$(div).innerHTML=data.map(c=>`
<div class="cierre-mensual-item">
<b>Conductor:</b> ${c.conductor_id}<br>
<b>KM:</b> ${c.km_recorridos}<br>
<b>Rendimiento:</b>
<span style="color:#22c55e">${c.rendimiento.toFixed(2)} km/L</span>
</div>
`).join('');
}
</script>

</body>
</html>
